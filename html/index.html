<!doctype html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=1280">
	<title>BuildBridge</title>
	<script type="text/javascript">
	if (location.href.indexOf(':8000') != -1) document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')
	</script>
	<script src="./js/plugin/jquery-1.9.1.min.js"></script>
	<script src="./js/plugin/jquery-ui-1.12.1.min.js"></script>
	<script src="./js/plugin/jquery.ui.touch-punch.min.js"></script>
	<script src="./js/plugin/jquery.easing.1.3.js"></script>
	<script src="./js/plugin/jquery.transform.js"></script>
	<link rel="stylesheet" type="text/css" href="./css/style.css">
</head>

<body>
	<div class="blgm_wrap">
		<div class="blgm_in animated">
			<div class="blgm_sasl tp01">
				<span class="sas sas01"></span>
				<span class="sas sas02"></span>
				<div class="sas_circle "></div>
			</div>
			<div class="blgm_lib tp01">
				<div class="lib_tp"></div>
				<div class="shd"></div>
			</div>
			<div class="blGroup">
				<div class="boxSlider"></div>
				<div class="guideline"></div>
				<div class="blGroupInBox">
					<div class="box b_bar bBar"></div>
				</div>
				<div class="bl_point blPoint">
					<span class="bl_point_in"></span>
				</div>
			</div>
			<div class="blgm_sasl tp02">
				<span class="sas sas03"></span>
				<span class="sas sas04"></span>
				<div class="sas_circle active"></div>
			</div>
			<div class="blgm_water_bar"></div>
			<div class="blgm_water">
				<div class="blgm_water_in waterHeightWrap">
					<div class="water_height waterHeight">
						<div class="water_br"></div>
					</div>
				</div>
			</div>
			<div class="blgm_lib tp02">
				<div class="lib_tp"></div>
				<div class="shd"></div>
			</div>
			<div class="bl_fail blFailEl"></div>
			<div class="blm_push blMPushBtn"></div>
		</div>
	</div>
	<script type="text/javascript">
	var BuildBridge = function(obj) {
		var _this = this;
		this.obj = $.extend(true, {
			contr: {
				left: 37,
				right: 39,
				drop: 32,
				mDrop: '.blMPushBtn',
			},
			successLength: 0,
			successPoint: 0,
			pointViewEl: '.blPoint',
			waterFailHeight: 0,
			waterHeight: 0,
			waterHeightWrap: '.waterHeightWrap',
			waterHeightEl: '.waterHeight',
			gameFailViewEl: '.blFailEl',
			uiSlider: '.boxSlider',
			uiSliderLeft: 0,
			uiSliderObj: {},
			box: [{
					clsnm: 'box01',
					point: 5,
					water: .5,
					width: 75,
				},
				{
					clsnm: 'box02',
					point: 10,
					water: 1,
					width: 111,
				},
				{
					clsnm: 'box03',
					point: 15,
					water: 1.5,
					width: 155,
				},
				{
					clsnm: 'box04',
					point: 20,
					water: 2,
					width: 202,
				},
			],
			random: false,
			boxAppendWrap: '.blGroupInBox',
			boxAddClass: '.dropBox',
			boxInitClass: '.box',
			boxInitBottom: '.bBar',
		}, obj);
		this.success = true;
		this.successLength = 0;
		this.crrtDropBox = null;
		this.crrtBoxCount = 0;
		this.nextDropBox = null;
		this.prevDropBox = null;
		this.prevDropBoxArry = [];
		this.crrtDropBoxObj = {};
		this.nextDropBoxObj = {};
		this.prevDropBoxObj = {};
		this.initGuideLine = function() {
			var w = $(_this.obj.boxInitBottom).width() + _this.obj.box[0].width;
			var l = $(_this.obj.boxInitBottom)[0].offsetLeft - (_this.obj.box[0].width / 2);
			var r = w + l;
			return {
				width: w,
				left: l,
				right: r,
			}
		};
		this.limitGuideLine = {
			width: _this.initGuideLine().width,
			left: _this.initGuideLine().left,
			right: _this.initGuideLine().right
		};
		this.boxCount = 0;
		this.boxLength = 0;
		this.boxHeight = 0;
		this.boxHistroyArry = [];
		this.boxAppendHtml = '';
		this.init();
	};
	BuildBridge.prototype = {
		init: function(obj) {
			if (location.href.indexOf('localhost:8000') != -1 || location.href.indexOf('github') != -1) {
				$('.guideline').stop().animate({
					'width': this.limitGuideLine.width,
					'left': this.limitGuideLine.left,
				}).css('background-color', '#fff');
			}
			this.set().slider();
			this.set().create();
			this.crrtDropBox = $(this.obj.boxInitBottom);
			this.boxPrevNextFun();
			this.setBoxHeight();
			this.dropBind();
		},
		set: function() {
			var _this = this;
			return {
				create: function() {
					if (!_this.obj.random) {
						_this.obj.box.forEach(function(items) {
							_this.boxAppendHtml += '<div class="box ' + items.clsnm + ' w' + items.width + ' ' + _this.glFun().clsFormat(_this.obj.boxAddClass) + '" style="width: ' + items.width + 'px; left: ' + _this.obj.uiSliderLeft + 'px;" data-count="' + _this.boxLength + '" data-box-width="' + items.width + '"></div>';
							_this.boxLength++;
						});
						$(_this.obj.boxAppendWrap).append(_this.boxAppendHtml);
						_this.boxAppendHtml = '';
					}
				},
				slider: function() {
					var $slider = $(_this.obj.uiSlider).slider($.extend(true, {
						slide: function(e, el) {
							_this.obj.uiSliderLeft = el.handle.offsetLeft;
							$(_this.obj.boxAddClass).not('.drop').css('left', _this.obj.uiSliderLeft);
							$('input[name=sliderValue]').val(_this.obj.uiSliderLeft);
						},
					}, _this.obj.uiSliderObj));
					return $slider;
				},
			};
		},
		aniCallb: function(callb) {
			return $.extend(false, {
				'duration': 1000,
				'easing': 'swing',
				'complete': function() {},
			}, callb);
		},
		boxPrevNextFun: function($target) {
			var _this = this;
			var $target = $target ? $target : this.crrtDropBox;
			if (!$target.next().is('.box')) {
				this.set().create();
			}
			this.nextDropBox = $target.next();
			if ($target.prev().is('.box')) {
				var $prev = $target.prev();
				this.prevDropBoxArry.push($prev);
				this.prevDropBoxArry.forEach(function(items) {
					if (!items.is('.false')) {
						_this.prevDropBox = items;
						return;
					}
				});
				this.prevDropBoxObj = this.setBoxPosition(this.prevDropBox);
				this.boxHistroyArry.unshift(this.prevDropBoxObj);
			}
			this.nextDropBoxObj = this.setBoxPosition(this.nextDropBox);
			this.crrtDropBoxObj = this.setBoxPosition(this.crrtDropBox);
			this.nextDropBox.css({
				'margin-left': -(this.nextDropBoxObj.width / 2)
			});
			$(this.obj.uiSlider).attr('data-type', '' + this.nextDropBoxObj.width);
		},
		setBoxPosition: function($target) {
			var $target = $target ? $target : this.crrtDropBox;
			var pos = {
				w: $target.outerWidth(),
				h: $target.outerHeight(),
				x: $target[0].offsetLeft,
				y: $target[0].offsetTop,
				r: $target.outerWidth() + $target[0].offsetLeft,
			};
			return {
				width: pos.w,
				height: pos.h,
				left: pos.x,
				top: pos.y,
				right: pos.r,
			};
		},
		setSuccess: function() {
			var _this = this;
			return {
				cls01: function() { //커렌트박스가. 리밋트라인의 left 보다 크고, 리밋트라인의 right보다 작을때
					if (_this.crrtDropBoxObj.left > _this.limitGuideLine.left && _this.crrtDropBoxObj.right < _this.limitGuideLine.right) {
						return true;
					} else {
						return false;
					}
				},
				cls02: function() {
					/*
					 * if(현재박스.width > 이전박스.너비)
					 *	if(커렌트박스가 , 히스토리박스중 가장 너비가 작은박스의  left보다 작고, right 클때 )
					 *else
					 *	if(커렌트박스가 , 히스토리박스중 가장 너비가 작은박스의  left보다 크고, right 작을때)
					 */
					var widthArry = [];
					_this.boxHistroyArry.forEach(function(items) {
						widthArry.push(items.width);
					});
					var minWidth = Math.min.apply(null, widthArry);
					for (var i = 0; i < _this.boxHistroyArry.length; i++) {
						if (_this.boxHistroyArry[i].width == minWidth) {
							var minWidthBoxObj = _this.boxHistroyArry[i];
							var crrtWidthBoxObj = _this.crrtDropBoxObj;
							if (crrtWidthBoxObj.width > _this.prevDropBoxObj.width) {
								if (crrtWidthBoxObj.left < minWidthBoxObj.left && crrtWidthBoxObj.right > minWidthBoxObj.right && (minWidthBoxObj.left - crrtWidthBoxObj.left) < minWidthBoxObj.width * 2 && (crrtWidthBoxObj.right - minWidthBoxObj.right) < minWidthBoxObj.width * 2) {
									return true;
								} else {
									return false;
								}
							} else {
								/*if (crrtBoxObj.left > minBoxObj.left && crrtBoxObj.right < minBoxObj.right) {
									return true;
								} else {
									return false;
								}*/
								return true;
							}
						}
					}
				},
				cls03: function() {},
			};
		},
		getSuccess: function() {
			if (this.setSuccess().cls01() && this.setSuccess().cls02()) {
				this.success = true;
				this.setLimitGuideLine(this.crrtDropBoxObj, this.nextDropBoxObj);
			} else {
				this.success = false;
				this.setLimitGuideLine(this.prevDropBoxObj, this.nextDropBoxObj);
			}
			this.successCallb();
		},
		successCallb: function() {
			var _this = this;
			var crrtBoxObj = null;
			this.obj.box.forEach(function(items) {
				if (items.width == _this.crrtDropBoxObj.width) {
					crrtBoxObj = {
						point: items.point,
						water: items.water,
					}
				}
			});
			if (this.success) {
				this.successLength++;
				this.obj.successPoint += crrtBoxObj.point;
				this.sucsCallbFun(crrtBoxObj.point);
			}
			this.obj.waterHeight += crrtBoxObj.water;
			this.waterHeightFun();
		},
		sucsCallbFun: function(crrtpoi) {
			$(this.obj.pointViewEl).append('<span class="bl_point_in po' + crrtpoi + '"></span>');

		},
		waterHeightFun: function() {
			var $maxHehight = $(this.obj.waterHeightWrap).height();
			var $top = $maxHehight - (($maxHehight * this.obj.waterHeight) / this.obj.waterFailHeight);
			var $val = $top > 0 ? $top : 0;
			$(this.obj.waterHeightEl).css({
				'top': $val
			});
		},
		setLimitGuideLine: function(prev, crrt) {
			var w = prev.width + crrt.width;
			var x = prev.left - (crrt.width / 2);
			var wx = w + x;
			this.limitGuideLine = {
				width: w,
				left: x,
				right: wx,
			};
			$('.guideline').stop().animate({
				'width': this.limitGuideLine.width,
				'left': this.limitGuideLine.left,
			}, this.aniCallb());
		},
		setBoxHeight: function() {
			if (this.success) {
				this.boxHeight += this.setBoxPosition().height;
			}
		},
		dropBind: function() {
			var _this = this;
			$(document).keyup(function() {
				var key = event.keyCode;
				if (key == _this.obj.contr.drop) {
					_this.bindCallbFun();
				}
			});
			$(this.obj.contr.mDrop).on({
				'click': function() {
					_this.bindCallbFun();
				},
			});
			$(document).click(function() {
				$('.ui-slider-handle').focus();
			}).click();
		},
		bindCallbFun: function() {
			this.crrtDropBox = $(this.obj.boxAddClass + '[data-count=' + this.boxCount + ']');
			this.boxPrevNextFun();
			this.getSuccess();
			this.setBoxHeight();
			this.dropMove();
			if (this.obj.waterHeight >= this.obj.waterFailHeight) {
				this.finishLineGame(false);
			}
		},
		finishLineGame: function(bool) {
			/*
			 * 포인트 : this.obj.successPoint
			 */
			if (bool) {
				alert('성공')
			} else {
				$(this.obj.gameFailViewEl).show().addClass('animated slideInDown');
			}
		},
		dropMove: function() {
			var _this = this;
			this.crrtDropBox.css({
				'visibility': 'visible',
			}).addClass('drop').animate({
				'top': $(this.obj.boxAppendWrap).height() - this.boxHeight
			}, this.aniCallb({
				'duration': 300,
				'complete': function() {
					if (_this.successLength == _this.obj.successLength) {
						_this.finishLineGame(true);
					}
				},
			}));
			if (!this.success) {
				this.crrtDropBox.addClass('false').animate({
					'opacity': 0
				}, this.aniCallb({
					'complete': function() {
						$(this).hide();
					},
				}));
			}
			this.boxCount++;
		},
		glFun: function() {
			var clsFormat = function(nm) {
				return nm.replace('.', '');
			};
			return {
				clsFormat: clsFormat,
			};
		},
	};

	var Game = {};
	var buildBridge = null;
	Game.start = function(gameCode, schedIndex, seqNo, pointMax, callback) {
		switch (gameCode) {
			case 1001:
				buildBridge = new BuildBridge({
					contr: {
						drop: 40,
						mDrop: '.blMPushBtn',
					},
					successLength: 8,
					waterFailHeight: 20,
				});
				break;
		}
	}

	function callback(gameCode, schedIndex, seqNo, point, errorCode, errorMessage) {
		//임시로 저장완료 리턴.
		return 1;
	}
	var divedeeper = {
		code: 1001, //게임코드(1001~1020)
		schedIndex: 121, // 학습일련번호 
		seqNo: 25, // 학습내 액티비티 번호
		pointMax: 25 //게임 최고획득점수(만점)
	}

	Game.start(divedeeper.code, divedeeper.schedIndex, divedeeper.seqNo, divedeeper.pointMax, callback);
	//포인트 == buildBridge.obj.successPoint 
	callback(divedeeper.code, divedeeper.schedIndex, divedeeper.seqNo, buildBridge.obj.successPoint);
	</script>
</body>

</html>